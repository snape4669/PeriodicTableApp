name: Release Build and Upload

on:
  release:
    types: [ published ]

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  actions: read

jobs:
  # Windowsæ„å»º
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        
    - name: Get version from tag
      id: get_version
      run: |
        $version = "${{ github.ref_name }}"
        if ($version.StartsWith("v")) {
          $version = $version.Substring(1)
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=${{ github.ref_name }}" >> $env:GITHUB_OUTPUT
        
    - name: Build Windows executable
      run: |
        $appName = "PeriodicTableApp-v${{ steps.get_version.outputs.version }}"
        echo "Building Windows executable: $appName"
        pyinstaller --onefile --windowed --name "$appName" periodic_table_app.py elements_data.py
        
    - name: Verify Windows build
      run: |
        $appName = "PeriodicTableApp-v${{ steps.get_version.outputs.version }}"
        $exePath = "dist\$appName.exe"
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          echo "âœ“ Windowså¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ: $exePath"
          echo "âœ“ æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
        } else {
          echo "âœ— Windowså¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå¤±è´¥"
          exit 1
        }
        
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: Windows-Executable
        path: dist/*.exe
        retention-days: 30

  # macOSæ„å»º
  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install pyinstaller
        pip3 install -r requirements.txt
        
    - name: Get version from tag
      id: get_version
      run: |
        version="${{ github.ref_name }}"
        if [[ $version == v* ]]; then
          version=${version#v}
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        
    - name: Build macOS application
      run: |
        appName="PeriodicTableApp-v${{ steps.get_version.outputs.version }}"
        echo "Building macOS application: $appName"
        pyinstaller --onefile --windowed --name "$appName" periodic_table_app.py elements_data.py
        
    - name: Create macOS .app bundle
      run: |
        appName="PeriodicTableApp-v${{ steps.get_version.outputs.version }}"
        appDir="${appName}.app"
        
        echo "Creating .app bundle: $appDir"
        mkdir -p "$appDir/Contents/MacOS"
        mkdir -p "$appDir/Contents/Resources"
        cp "dist/$appName" "$appDir/Contents/MacOS/"
        
        # åˆ›å»ºInfo.plistæ–‡ä»¶
        echo '<?xml version="1.0" encoding="UTF-8"?>' > "$appDir/Contents/Info.plist"
        echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$appDir/Contents/Info.plist"
        echo '<plist version="1.0">' >> "$appDir/Contents/Info.plist"
        echo '<dict>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleExecutable</key>' >> "$appDir/Contents/Info.plist"
        echo "    <string>$appName</string>" >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleIdentifier</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>com.periodictable.app</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleName</key>' >> "$appDir/Contents/Info.plist"
        echo "    <string>$appName</string>" >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleVersion</key>' >> "$appDir/Contents/Info.plist"
        echo "    <string>${{ steps.get_version.outputs.version }}</string>" >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleShortVersionString</key>' >> "$appDir/Contents/Info.plist"
        echo "    <string>${{ steps.get_version.outputs.version }}</string>" >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundlePackageType</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>APPL</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleSignature</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>????</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>LSMinimumSystemVersion</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>10.13.0</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>NSHighResolutionCapable</key>' >> "$appDir/Contents/Info.plist"
        echo '    <true/>' >> "$appDir/Contents/Info.plist"
        echo '</dict>' >> "$appDir/Contents/Info.plist"
        echo '</plist>' >> "$appDir/Contents/Info.plist"
        
        echo "âœ“ macOSåº”ç”¨ç¨‹åºåŒ…åˆ›å»ºæˆåŠŸ: $appDir"
        
    - name: Verify macOS build
      run: |
        appName="PeriodicTableApp-v${{ steps.get_version.outputs.version }}"
        exePath="dist/$appName"
        appPath="${appName}.app"
        
        if [ -f "$exePath" ] && [ -d "$appPath" ]; then
          exeSize=$(($(stat -f%z "$exePath") / 1024 / 1024))
          echo "âœ“ macOSå¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ: $exePath"
          echo "âœ“ æ–‡ä»¶å¤§å°: ${exeSize} MB"
          echo "âœ“ åº”ç”¨ç¨‹åºåŒ…åˆ›å»ºæˆåŠŸ: $appPath"
        else
          echo "âœ— macOSæ„å»ºå¤±è´¥"
          exit 1
        fi
        
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macOS-Application
        path: |
          dist/PeriodicTableApp-v${{ steps.get_version.outputs.version }}
          PeriodicTableApp-v${{ steps.get_version.outputs.version }}.app/
        retention-days: 30

  # ä¸Šä¼ åˆ°Release
  upload-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: Windows-Executable
        path: windows/
        
    - name: Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: macOS-Application
        path: macos/
        
    - name: List downloaded files
      run: |
        echo "=== Windowsæ„å»ºäº§ç‰© ==="
        ls -la windows/
        echo ""
        echo "=== macOSæ„å»ºäº§ç‰© ==="
        ls -la macos/
        
    - name: Create Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          windows/*.exe
          macos/PeriodicTableApp-v*
          macos/*.app/
        draft: false
        prerelease: false
        tag_name: ${{ github.ref_name }}
        name: "å…ƒç´ å‘¨æœŸè¡¨æŸ¥è¯¢å·¥å…· v${{ github.ref_name }}"
        body: |
          ## ğŸ‰ å…ƒç´ å‘¨æœŸè¡¨æŸ¥è¯¢å·¥å…· v${{ github.ref_name }}
          
          ### ğŸš€ æ›´æ–°å†…å®¹
          - è‡ªåŠ¨æ„å»ºçš„å¤šå¹³å°åº”ç”¨ç¨‹åº
          - æ”¯æŒé€šè¿‡å…ƒç´ ç¬¦å·ã€ä¸­æ–‡åç§°ã€è‹±æ–‡åç§°æœç´¢
          - åŒ…å«119ç§å·²çŸ¥åŒ–å­¦å…ƒç´ çš„è¯¦ç»†ä¿¡æ¯
          - **æ•°æ®å·²å†…ç½®ï¼Œæ— éœ€å¤–éƒ¨æ–‡ä»¶**
          
          ### ğŸ’» æ”¯æŒå¹³å°
          - **Windows**: PeriodicTableApp-v${{ steps.get_version.outputs.version }}.exe
          - **macOS**: PeriodicTableApp-v${{ steps.get_version.outputs.version }}.app + å¯æ‰§è¡Œæ–‡ä»¶
          
          ### ğŸ“– ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„æ„å»ºäº§ç‰©
          2. è§£å‹æ–‡ä»¶ï¼ˆå¦‚éœ€è¦ï¼‰
          3. åŒå‡»è¿è¡Œåº”ç”¨ç¨‹åº
          4. åœ¨æœç´¢æ¡†ä¸­è¾“å…¥å…ƒç´ ç¬¦å·æˆ–åç§°
          5. æŸ¥çœ‹å…ƒç´ çš„è¯¦ç»†ä¿¡æ¯
          
          ### ğŸ“‹ æ„å»ºä¿¡æ¯
          - ç‰ˆæœ¬: ${{ github.ref_name }}
          - æ„å»ºæ—¶é—´: ${{ github.event.release.published_at }}
          - æ„å»ºç¯å¢ƒ: GitHub Actions
          - æ•°æ®æ¥æº: å†…ç½®119ä¸ªåŒ–å­¦å…ƒç´ æ•°æ®
          
          ### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
          - åŸºäºPython + tkinterçš„ç°ä»£åŒ–GUI
          - ä½¿ç”¨PyInstalleræ‰“åŒ…ï¼Œæ— éœ€Pythonç¯å¢ƒ
          - æ•°æ®å®Œå…¨å†…ç½®ï¼Œç¡®ä¿ç¨‹åºå®Œæ•´æ€§
          
          ---
          
          *æ­¤ç‰ˆæœ¬ç”±GitHub Actionsè‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒ*
