name: Build Windows Executable

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        
    - name: Get version from tag
      id: get_version
      if: github.event_name == 'release'
      run: |
        $version = "${{ github.ref_name }}"
        if ($version.StartsWith("v")) {
          $version = $version.Substring(1)
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=${{ github.ref_name }}" >> $env:GITHUB_OUTPUT
        
    - name: Build executable
      run: |
        if ("${{ github.event_name }}" -eq "release") {
          $appName = "å…ƒç´ å‘¨æœŸè¡¨æŸ¥è¯¢å·¥å…·-v${{ steps.get_version.outputs.version }}"
        } else {
          $appName = "å…ƒç´ å‘¨æœŸè¡¨æŸ¥è¯¢å·¥å…·"
        }
        pyinstaller --onefile --windowed --name "$appName" periodic_table_app.py elements_data.py
        
    - name: Rename executable for release
      if: github.event_name == 'release'
      run: |
        $appName = "å…ƒç´ å‘¨æœŸè¡¨æŸ¥è¯¢å·¥å…·-v${{ steps.get_version.outputs.version }}"
        $exePath = "dist\$appName.exe"
        if (Test-Path $exePath) {
          echo "âœ“ å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ: $exePath"
        } else {
          echo "âœ— å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå¤±è´¥"
          exit 1
        }
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PeriodicTableApp-Windows
        path: dist/
        
    - name: Create Release Assets
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.exe
        draft: false
        prerelease: false
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: "å…ƒç´ å‘¨æœŸè¡¨æŸ¥è¯¢å·¥å…· v${{ steps.get_version.outputs.version }}"
        body: |
          ## å…ƒç´ å‘¨æœŸè¡¨æŸ¥è¯¢å·¥å…· v${{ steps.get_version.outputs.version }}
          
          ### ğŸš€ æ›´æ–°å†…å®¹
          - è‡ªåŠ¨æ„å»ºçš„Windowså¯æ‰§è¡Œæ–‡ä»¶
          - æ”¯æŒé€šè¿‡å…ƒç´ ç¬¦å·ã€ä¸­æ–‡åç§°ã€è‹±æ–‡åç§°æœç´¢
          - åŒ…å«119ç§å·²çŸ¥åŒ–å­¦å…ƒç´ çš„è¯¦ç»†ä¿¡æ¯
          - **æ•°æ®å·²å†…ç½®ï¼Œæ— éœ€å¤–éƒ¨æ–‡ä»¶**
          
          ### ğŸ’» ç³»ç»Ÿè¦æ±‚
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - æ— éœ€å®‰è£…Pythonï¼Œå³å¼€å³ç”¨
          
          ### ğŸ“– ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹æ–‡ä»¶
          2. åŒå‡»è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
          3. åœ¨æœç´¢æ¡†ä¸­è¾“å…¥å…ƒç´ ç¬¦å·æˆ–åç§°
          4. æŸ¥çœ‹å…ƒç´ çš„è¯¦ç»†ä¿¡æ¯
          
          ### ğŸ“‹ æ–‡ä»¶ä¿¡æ¯
          - æ–‡ä»¶å: å…ƒç´ å‘¨æœŸè¡¨æŸ¥è¯¢å·¥å…·-v${{ steps.get_version.outputs.version }}.exe
          - æ„å»ºæ—¶é—´: ${{ github.event.release.published_at }}
          - æ„å»ºç¯å¢ƒ: Windows Latest (GitHub Actions)
          - æ•°æ®æ¥æº: å†…ç½®119ä¸ªåŒ–å­¦å…ƒç´ æ•°æ®
