name: Build macOS Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

# 添加权限配置
permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        
    - name: Get version from tag
      id: get_version
      if: github.event_name == 'release'
      run: |
        version="${{ github.ref_name }}"
        if [[ $version == v* ]]; then
          version=${version#v}
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        
               - name: Build application
             run: |
               if [ "${{ github.event_name }}" = "release" ]; then
                 appName="PeriodicTableApp-v${{ steps.get_version.outputs.version }}"
               else
                 appName="PeriodicTableApp"
               fi
               echo "Building application: $appName"
               pyinstaller --onefile --windowed --name "$appName" periodic_table_app.py elements_data.py
        
    - name: Create .app bundle
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          appName="PeriodicTableApp-v${{ steps.get_version.outputs.version }}"
          appDir="${appName}.app"
        else
          appName="PeriodicTableApp"
          appDir="PeriodicTableApp.app"
        fi
        
        echo "Creating .app bundle: $appDir"
        mkdir -p "$appDir/Contents/MacOS"
        mkdir -p "$appDir/Contents/Resources"
        cp "dist/$appName" "$appDir/Contents/MacOS/"
        
        # 创建Info.plist文件
        echo '<?xml version="1.0" encoding="UTF-8"?>' > "$appDir/Contents/Info.plist"
        echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$appDir/Contents/Info.plist"
        echo '<plist version="1.0">' >> "$appDir/Contents/Info.plist"
        echo '<dict>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleExecutable</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>PeriodicTableApp</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleIdentifier</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>com.periodictable.app</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleName</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>PeriodicTableApp</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleVersion</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>1.0.0</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleShortVersionString</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>1.0.0</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundlePackageType</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>APPL</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleSignature</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>????</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>LSMinimumSystemVersion</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>10.13.0</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>NSHighResolutionCapable</key>' >> "$appDir/Contents/Info.plist"
        echo '    <true/>' >> "$appDir/Contents/Info.plist"
        echo '</dict>' >> "$appDir/Contents/Info.plist"
        echo '</plist>' >> "$appDir/Contents/Info.plist"
        
        echo "✓ macOS应用程序包创建成功: $appDir"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PeriodicTableApp-macOS
        path: |
          dist/
          *.app/
        
    - name: Create Release Assets
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/PeriodicTableApp-v${{ steps.get_version.outputs.version }}
          PeriodicTableApp-v${{ steps.get_version.outputs.version }}.app/
        draft: false
        prerelease: false
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: "元素周期表查询工具 v${{ steps.get_version.outputs.version }}"
        body: |
          ## 元素周期表查询工具 v${{ steps.get_version.outputs.version }}
          
          ### 更新内容
          - 自动构建的macOS应用程序
          - 支持通过元素符号、中文名称、英文名称搜索
          - 包含118种已知化学元素的详细信息
          
          ### 系统要求
          - macOS 10.13 或更高版本
          - 无需安装Python，即开即用
          
          ### 使用方法
          1. 下载并解压文件
          2. 双击运行应用程序包
          3. 在搜索框中输入元素符号或名称
          4. 查看元素的详细信息
          
          ### 文件信息
          - 可执行文件: PeriodicTableApp-v${{ steps.get_version.outputs.version }}
          - 应用程序包: PeriodicTableApp-v${{ steps.get_version.outputs.version }}.app
          - 构建时间: ${{ github.event.release.published_at }}
          - 构建环境: macOS Latest (GitHub Actions)
