name: Build macOS Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        
    - name: Get version from tag
      id: get_version
      if: github.event_name == 'release'
      run: |
        version="${{ github.ref_name }}"
        if [[ $version == v* ]]; then
          version=${version#v}
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        
    - name: Build application
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          appName="PeriodicTableApp-v${{ steps.get_version.outputs.version }}"
        else
          appName="PeriodicTableApp"
        fi
        echo "Building application: $appName"
        pyinstaller --onefile --windowed --name "$appName" periodic_table_app.py elements_data.py
        
    - name: Create .app bundle
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          appName="PeriodicTableApp-v${{ steps.get_version.outputs.version }}"
          appDir="${appName}.app"
        else
          appName="PeriodicTableApp"
          appDir="PeriodicTableApp.app"
        fi
        
        echo "Creating .app bundle: $appDir"
        mkdir -p "$appDir/Contents/MacOS"
        mkdir -p "$appDir/Contents/Resources"
        cp "dist/$appName" "$appDir/Contents/MacOS/"
        
        # åˆ›å»ºInfo.plistæ–‡ä»¶
        echo '<?xml version="1.0" encoding="UTF-8"?>' > "$appDir/Contents/Info.plist"
        echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$appDir/Contents/Info.plist"
        echo '<plist version="1.0">' >> "$appDir/Contents/Info.plist"
        echo '<dict>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleExecutable</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>PeriodicTableApp</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleIdentifier</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>com.periodictable.app</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleName</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>PeriodicTableApp</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleVersion</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>1.0.0</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleShortVersionString</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>1.0.0</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundlePackageType</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>APPL</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>CFBundleSignature</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>????</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>LSMinimumSystemVersion</key>' >> "$appDir/Contents/Info.plist"
        echo '    <string>10.13.0</string>' >> "$appDir/Contents/Info.plist"
        echo '    <key>NSHighResolutionCapable</key>' >> "$appDir/Contents/Info.plist"
        echo '    <true/>' >> "$appDir/Contents/Info.plist"
        echo '</dict>' >> "$appDir/Contents/Info.plist"
        echo '</plist>' >> "$appDir/Contents/Info.plist"
        
        echo "âœ“ macOSåº”ç”¨ç¨‹åºåŒ…åˆ›å»ºæˆåŠŸ: $appDir"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PeriodicTableApp-macOS
        path: |
          dist/
          *.app/
        
    - name: Create Release Assets
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/PeriodicTableApp-v${{ steps.get_version.outputs.version }}
          PeriodicTableApp-v${{ steps.get_version.outputs.version }}.app/
        draft: false
        prerelease: false
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: "å…ƒç´ å‘¨æœŸè¡¨æŸ¥è¯¢å·¥å…· v${{ steps.get_version.outputs.version }}"
        body: |
          ## å…ƒç´ å‘¨æœŸè¡¨æŸ¥è¯¢å·¥å…· v${{ steps.get_version.outputs.version }}
          
          ### ğŸš€ æ›´æ–°å†…å®¹
          - è‡ªåŠ¨æ„å»ºçš„macOSåº”ç”¨ç¨‹åº
          - æ”¯æŒé€šè¿‡å…ƒç´ ç¬¦å·ã€ä¸­æ–‡åç§°ã€è‹±æ–‡åç§°æœç´¢
          - åŒ…å«119ç§å·²çŸ¥åŒ–å­¦å…ƒç´ çš„è¯¦ç»†ä¿¡æ¯
          - **æ•°æ®å·²å†…ç½®ï¼Œæ— éœ€å¤–éƒ¨æ–‡ä»¶**
          
          ### ğŸ’» ç³»ç»Ÿè¦æ±‚
          - macOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬
          - æ— éœ€å®‰è£…Pythonï¼Œå³å¼€å³ç”¨
          
          ### ğŸ“– ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹æ–‡ä»¶
          2. åŒå‡»è¿è¡Œåº”ç”¨ç¨‹åºåŒ…
          3. åœ¨æœç´¢æ¡†ä¸­è¾“å…¥å…ƒç´ ç¬¦å·æˆ–åç§°
          4. æŸ¥çœ‹å…ƒç´ çš„è¯¦ç»†ä¿¡æ¯
          
          ### ğŸ“‹ æ–‡ä»¶ä¿¡æ¯
          - å¯æ‰§è¡Œæ–‡ä»¶: PeriodicTableApp-v${{ steps.get_version.outputs.version }}
          - åº”ç”¨ç¨‹åºåŒ…: PeriodicTableApp-v${{ steps.get_version.outputs.version }}.app
          - æ„å»ºæ—¶é—´: ${{ github.event.release.published_at }}
          - æ„å»ºç¯å¢ƒ: macOS Latest (GitHub Actions)
          - æ•°æ®æ¥æº: å†…ç½®119ä¸ªåŒ–å­¦å…ƒç´ æ•°æ®
